<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Panel - CyberScripts Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            width: 250px;
            background: #1a1a1a;
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .admin-logo {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .admin-logo h2 {
            color: #00ff88;
        }

        .admin-menu {
            padding: 2rem 0;
        }

        .admin-menu-item {
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .admin-menu-item:hover,
        .admin-menu-item.active {
            background: rgba(0,255,136,0.1);
            border-left-color: #00ff88;
        }

        .admin-menu-item i {
            width: 20px;
        }

        /* Main Content */
        .admin-main {
            margin-left: 250px;
            flex: 1;
            padding: 2rem;
            width: calc(100% - 250px);
        }

        .admin-header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-section h2 {
            margin-bottom: 1.5rem;
            color: #1a1a1a;
        }

        /* Form Styles */
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #00ff88;
            color: #1a1a1a;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #00cc6a;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Upload File */
        .file-upload {
            border: 2px dashed #00ff88;
            padding: 2rem;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            background: rgba(0,255,136,0.05);
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload i {
            font-size: 3rem;
            color: #00ff88;
            margin-bottom: 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem;
            border-radius: 10px;
            color: white;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            opacity: 0.9;
        }

        /* Tab System */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            border-bottom-color: #00ff88;
            color: #00ff88;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: #00ff88;
            color: #1a1a1a;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Order Management Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-warning {
            background: #ffc107;
            color: #000;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        .badge-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .filter-btn {
            background: white;
            color: #333;
            border: 2px solid #ddd;
        }

        .filter-btn.active {
            background: #00ff88;
            border-color: #00ff88;
            color: #1a1a1a;
        }

        .filter-btn:hover {
            border-color: #00ff88;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .close:hover {
            color: #333;
        }

        #loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
        }

        #loading i {
            font-size: 3rem;
            color: #00ff88;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h2><i class="fas fa-shield-alt"></i> CyberScripts Pro</h2>
                <p style="font-size: 0.9rem; color: #999; margin-top: 0.5rem;">Admin Panel</p>
            </div>
            
            <nav class="admin-menu">
                <div class="admin-menu-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="admin-menu-item" onclick="showSection('scripts')">
                    <i class="fas fa-code"></i>
                    <span>Upload Scripts</span>
                </div>
                <div class="admin-menu-item" onclick="showSection('courses')">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Upload Courses</span>
                </div>
                <div class="admin-menu-item" onclick="showSection('blogs')">
                    <i class="fas fa-blog"></i>
                    <span>Upload Blogs</span>
                </div>
                <div class="admin-menu-item" onclick="showSection('users')">
                    <i class="fas fa-users"></i>
                    <span>Manage Users</span>
                </div>
                <div class="admin-menu-item" onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </div>
                <div class="admin-menu-item" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i>
                    <span>Back to Website</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Header -->
            <div class="admin-header">
                <div>
                    <h1>Admin Dashboard</h1>
                    <p style="color: #666; margin-top: 0.5rem;">Welcome back, Admin!</p>
                </div>
                <div>
                    <span id="admin-user-name">Admin User</span>
                    <button class="btn btn-secondary" onclick="logout()" style="margin-left: 1rem;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="section-dashboard" class="section-content">
                <div class="stats-grid">
                    <div class="stat-card green">
                        <h3 id="total-products">0</h3>
                        <p>Total Products</p>
                    </div>
                    <div class="stat-card blue">
                        <h3 id="total-users">0</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card orange">
                        <h3 id="total-orders">0</h3>
                        <p>Total Orders</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-revenue">$0</h3>
                        <p>Total Revenue</p>
                    </div>
                </div>

                <div class="admin-section">
                    <h2>Recent Activity</h2>
                    <p>No recent activity to display.</p>
                </div>
            </div>

            <!-- Upload Scripts Section -->
            <div id="section-scripts" class="section-content" style="display: none;">
                <div class="admin-section">
                    <h2><i class="fas fa-code"></i> Upload New Script</h2>
                    <form class="upload-form" id="script-form" onsubmit="uploadScript(event)">
                        <div class="form-group">
                            <label>Script Title *</label>
                            <input type="text" name="title" required placeholder="e.g., Network Vulnerability Scanner">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Category *</label>
                                <select name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="network">Network Security</option>
                                    <option value="web">Web Security</option>
                                    <option value="cloud">Cloud Security</option>
                                    <option value="malware">Malware Analysis</option>
                                    <option value="forensics">Digital Forensics</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Price ($) *</label>
                                <input type="number" name="price" required step="0.01" placeholder="49.99">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Description *</label>
                            <textarea name="description" required placeholder="Detailed description of the script..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Features (one per line)</label>
                            <textarea name="features" placeholder="Feature 1&#10;Feature 2&#10;Feature 3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Upload Script File</label>
                            <div class="file-upload" onclick="document.getElementById('script-file').click()">
                                <input type="file" id="script-file" name="file" accept=".py,.sh,.js,.zip">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Click to upload script file (.py, .sh, .js, .zip)</p>
                                <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;" id="script-file-name"></p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload Script
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear Form
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Existing Scripts List -->
                <div class="admin-section" style="margin-top: 2rem;">
                    <h3><i class="fas fa-list"></i> Existing Scripts</h3>
                    <div id="scripts-list">
                        <p style="text-align: center; color: #999;">Loading scripts...</p>
                    </div>
                </div>
            </div>

            <!-- Upload Courses Section -->
            <div id="section-courses" class="section-content" style="display: none;">
                <div class="admin-section">
                    <h2><i class="fas fa-graduation-cap"></i> Upload New Course</h2>
                    <form class="upload-form" id="course-form" onsubmit="uploadCourse(event)">
                        <div class="form-group">
                            <label>Course Title *</label>
                            <input type="text" name="title" required placeholder="e.g., Complete Ethical Hacking Course">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Level *</label>
                                <select name="level" required>
                                    <option value="">Select Level</option>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Duration (hours)</label>
                                <input type="number" name="duration" placeholder="20">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Price ($) *</label>
                                <input type="number" name="price" required step="0.01" placeholder="199.99">
                            </div>
                            <div class="form-group">
                                <label>Instructor</label>
                                <input type="text" name="instructor" placeholder="Instructor Name">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Description *</label>
                            <textarea name="description" required placeholder="Course overview and what students will learn..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Course Modules (one per line)</label>
                            <textarea name="modules" placeholder="Module 1: Introduction&#10;Module 2: Basics&#10;Module 3: Advanced Topics"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Upload Course Thumbnail</label>
                            <div class="file-upload" onclick="document.getElementById('course-thumbnail').click()">
                                <input type="file" id="course-thumbnail" name="thumbnail" accept="image/*">
                                <i class="fas fa-image"></i>
                                <p>Click to upload course thumbnail</p>
                                <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;" id="course-thumbnail-name"></p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> Upload Course
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear Form
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Existing Courses List -->
                <div class="admin-section" style="margin-top: 2rem;">
                    <h3><i class="fas fa-list"></i> Existing Courses</h3>
                    <div id="courses-list">
                        <p style="text-align: center; color: #999;">Loading courses...</p>
                    </div>
                </div>
            </div>

            <!-- Upload Blogs Section -->
            <div id="section-blogs" class="section-content" style="display: none;">
                <div class="admin-section">
                    <h2><i class="fas fa-blog"></i> Create New Blog Post</h2>
                    <form class="upload-form" id="blog-form" onsubmit="uploadBlog(event)">
                        <div class="form-group">
                            <label>Blog Title *</label>
                            <input type="text" name="title" required placeholder="e.g., Top 10 Cybersecurity Trends in 2024">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Category *</label>
                                <select name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="news">News</option>
                                    <option value="tutorial">Tutorial</option>
                                    <option value="research">Research</option>
                                    <option value="tips">Tips & Tricks</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Author</label>
                                <input type="text" name="author" placeholder="Author Name">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Blog Content *</label>
                            <textarea name="content" required style="min-height: 300px;" placeholder="Write your blog post content here..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Tags (comma-separated)</label>
                            <input type="text" name="tags" placeholder="cybersecurity, hacking, tutorial">
                        </div>

                        <div class="form-group">
                            <label>Featured Image</label>
                            <div class="file-upload" onclick="document.getElementById('blog-image').click()">
                                <input type="file" id="blog-image" name="image" accept="image/*">
                                <i class="fas fa-image"></i>
                                <p>Click to upload featured image</p>
                                <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;" id="blog-image-name"></p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Publish Blog
                            </button>
                            <button type="button" class="btn btn-secondary">
                                <i class="fas fa-save"></i> Save as Draft
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Existing Blogs List -->
                <div class="admin-section" style="margin-top: 2rem;">
                    <h3><i class="fas fa-list"></i> Existing Blogs</h3>
                    <div id="blogs-list">
                        <p style="text-align: center; color: #999;">Loading blogs...</p>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="section-users" class="section-content" style="display: none;">
                <div class="admin-section">
                    <h2><i class="fas fa-users"></i> User Management</h2>
                    <div style="margin-bottom: 1.5rem;">
                        <button class="btn btn-primary" onclick="loadUsers()">
                            <i class="fas fa-sync"></i> Refresh Users
                        </button>
                    </div>
                    
                    <div id="users-loading" style="text-align: center; padding: 2rem; display: none;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #00ff88;"></i>
                        <p>Loading users...</p>
                    </div>
                    
                    <div id="users-table-container">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f5f5f5;">
                                <tr>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Name</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Email</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Role</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Status</th>
                                    <th style="padding: 1rem; text-align: left; border-bottom: 2px solid #ddd;">Joined</th>
                                    <th style="padding: 1rem; text-align: center; border-bottom: 2px solid #ddd;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody">
                                <tr>
                                    <td colspan="6" style="padding: 2rem; text-align: center; color: #999;">
                                        Click "Refresh Users" to load data
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="section-orders" class="section-content" style="display: none;">
                <!-- Order Statistics -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card orange">
                        <h3 id="pending-orders-count">0</h3>
                        <p><i class="fas fa-clock"></i> Pending Orders</p>
                    </div>
                    <div class="stat-card green">
                        <h3 id="verified-orders-count">0</h3>
                        <p><i class="fas fa-check-circle"></i> Verified Orders</p>
                    </div>
                    <div class="stat-card blue">
                        <h3 id="total-revenue">₹0</h3>
                        <p><i class="fas fa-money-bill-wave"></i> Total Revenue</p>
                    </div>
                </div>

                <div class="admin-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2><i class="fas fa-receipt"></i> Orders Management</h2>
                        <button class="btn btn-primary" onclick="loadOrders()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>

                    <!-- Filter Buttons -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                        <button class="btn filter-btn active" onclick="filterOrders('')">
                            <i class="fas fa-list"></i> All Orders
                        </button>
                        <button class="btn filter-btn" onclick="filterOrders('pending_verification')">
                            <i class="fas fa-clock"></i> Pending
                        </button>
                        <button class="btn filter-btn" onclick="filterOrders('verified')">
                            <i class="fas fa-check"></i> Verified
                        </button>
                        <button class="btn filter-btn" onclick="filterOrders('rejected')">
                            <i class="fas fa-times"></i> Rejected
                        </button>
                    </div>

                    <!-- Orders List Container -->
                    <div id="orders-list">
                        <div style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Loading orders...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Indicator -->
    <div id="loading">
        <i class="fas fa-spinner fa-spin"></i>
        <p style="margin-top: 1rem;">Loading...</p>
    </div>

    <script>
        const API_BASE_URL = 'https://cycber-1.onrender.com/api/v1';

        // Immediately check authentication before page loads
        (function() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');
            
            // Hide entire page initially
            document.body.style.display = 'none';
            
            if (!token || !user.role || user.role !== 'admin') {
                // Redirect immediately without showing page
                window.location.replace('index.html');
                return;
            }
        })();

        // Check admin authentication
        function checkAdminAuth() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');
            
            if (!token) {
                console.log('❌ No token found - redirecting');
                window.location.replace('index.html');
                return false;
            }
            
            if (!user.role || user.role !== 'admin') {
                console.log('❌ Not admin role:', user.role);
                window.location.replace('index.html');
                return false;
            }
            
            // Show page only if admin
            document.body.style.display = 'block';
            console.log('✅ Admin authenticated:', user.name);
            document.getElementById('admin-user-name').textContent = user.name || 'Admin';
            return true;
        }

        // Show section
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.admin-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById(`section-${sectionName}`);
            if (section) {
                section.style.display = 'block';
            }
            
            // Add active class to clicked menu item
            event.target.closest('.admin-menu-item').classList.add('active');
        }

        // Upload Script
        async function uploadScript(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/scripts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('✅ Script uploaded successfully!', 'success');
                    event.target.reset();
                    loadScripts(); // Refresh list
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification('Error uploading script: ' + error.message, 'error');
            }
        }
        
        // Load Scripts
        async function loadScripts() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/scripts`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayScriptsList(data.data.scripts);
                }
            } catch (error) {
                console.error('Error loading scripts:', error);
            }
        }
        
        // Display Scripts List
        function displayScriptsList(scripts) {
            const container = document.getElementById('scripts-list');
            if (!container) return;
            
            if (scripts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No scripts uploaded yet</p>';
                return;
            }
            
            container.innerHTML = scripts.map(script => `
                <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0;">${script.name}</h4>
                            <p style="color: #666; margin: 0.25rem 0;"><strong>Category:</strong> ${script.subcategory || 'N/A'}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><strong>Price:</strong> ₹${script.price}</p>
                            <p style="color: #666; margin: 0.25rem 0; font-size: 0.9rem;">${script.description || 'No description'}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editScript('${script._id}')" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteScript('${script._id}')" class="btn" style="background: #f44336; color: white; padding: 0.5rem 1rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Delete Script
        async function deleteScript(id) {
            if (!confirm('Are you sure you want to delete this script?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/scripts/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok || response.status === 204) {
                    showNotification('Script deleted successfully', 'success');
                    loadScripts();
                }
            } catch (error) {
                showNotification('Error deleting script: ' + error.message, 'error');
            }
        }

        // Upload Course
        async function uploadCourse(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/courses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('✅ Course uploaded successfully!', 'success');
                    event.target.reset();
                    loadCourses();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification('Error uploading course: ' + error.message, 'error');
            }
        }
        
        // Load Courses
        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/courses`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayCoursesList(data.data.courses);
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }
        
        // Display Courses List
        function displayCoursesList(courses) {
            const container = document.getElementById('courses-list');
            if (!container) return;
            
            if (courses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No courses uploaded yet</p>';
                return;
            }
            
            container.innerHTML = courses.map(course => `
                <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0;">${course.name}</h4>
                            <p style="color: #666; margin: 0.25rem 0;"><strong>Level:</strong> ${course.subcategory || 'N/A'}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><strong>Price:</strong> ₹${course.price}</p>
                            ${course.instructor ? `<p style="color: #666; margin: 0.25rem 0;"><strong>Instructor:</strong> ${course.instructor}</p>` : ''}
                            <p style="color: #666; margin: 0.25rem 0; font-size: 0.9rem;">${course.description || 'No description'}</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editCourse('${course._id}')" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteCourse('${course._id}')" class="btn" style="background: #f44336; color: white; padding: 0.5rem 1rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Delete Course
        async function deleteCourse(id) {
            if (!confirm('Are you sure you want to delete this course?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/courses/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok || response.status === 204) {
                    showNotification('Course deleted successfully', 'success');
                    loadCourses();
                }
            } catch (error) {
                showNotification('Error deleting course: ' + error.message, 'error');
            }
        }

        // Upload Blog
        async function uploadBlog(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/blogs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('✅ Blog published successfully!', 'success');
                    event.target.reset();
                    loadBlogs();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showNotification('Error publishing blog: ' + error.message, 'error');
            }
        }
        
        // Load Blogs
        async function loadBlogs() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/blogs`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayBlogsList(data.data.blogs);
                }
            } catch (error) {
                console.error('Error loading blogs:', error);
            }
        }
        
        // Display Blogs List
        function displayBlogsList(blogs) {
            const container = document.getElementById('blogs-list');
            if (!container) return;
            
            if (blogs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No blogs published yet</p>';
                return;
            }
            
            container.innerHTML = blogs.map(blog => `
                <div style="border: 1px solid #ddd; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0;">${blog.title}</h4>
                            <p style="color: #666; margin: 0.25rem 0;"><strong>Category:</strong> ${blog.category}</p>
                            <p style="color: #666; margin: 0.25rem 0;"><strong>Author:</strong> ${blog.author}</p>
                            <p style="color: #666; margin: 0.25rem 0; font-size: 0.9rem;">${blog.content.substring(0, 150)}...</p>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="editBlog('${blog._id}')" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button onclick="deleteBlog('${blog._id}')" class="btn" style="background: #f44336; color: white; padding: 0.5rem 1rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Delete Blog
        async function deleteBlog(id) {
            if (!confirm('Are you sure you want to delete this blog?')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/blogs/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok || response.status === 204) {
                    showNotification('Blog deleted successfully', 'success');
                    loadBlogs();
                }
            } catch (error) {
                showNotification('Error deleting blog: ' + error.message, 'error');
            }
        }
        
        // Edit Script
        function editScript(id) {
            const scripts = Array.from(document.querySelectorAll('#scripts-list > div'));
            const scriptCard = scripts.find(card => card.querySelector(`button[onclick*="${id}"]`));
            if (!scriptCard) return;
            
            const title = scriptCard.querySelector('h4').textContent;
            const category = scriptCard.textContent.match(/Category: ([^\n]+)/)?.[1] || '';
            const price = scriptCard.textContent.match(/Price: ₹([\d.]+)/)?.[1] || '';
            const description = scriptCard.textContent.match(/₹[\d.]+\n(.+)/s)?.[1]?.trim() || '';
            
            // Scroll to form and fill it
            document.getElementById('section-scripts').scrollIntoView({ behavior: 'smooth' });
            const form = document.getElementById('script-form');
            form.title.value = title;
            form.category.value = category.toLowerCase();
            form.price.value = price;
            form.description.value = description;
            
            // Store ID for update
            form.dataset.editId = id;
            form.querySelector('.btn-primary').innerHTML = '<i class="fas fa-save"></i> Update Script';
            showNotification('Editing: ' + title, 'info');
        }
        
        // Edit Course
        function editCourse(id) {
            const courses = Array.from(document.querySelectorAll('#courses-list > div'));
            const courseCard = courses.find(card => card.querySelector(`button[onclick*="${id}"]`));
            if (!courseCard) return;
            
            const title = courseCard.querySelector('h4').textContent;
            const level = courseCard.textContent.match(/Level: ([^\n]+)/)?.[1] || '';
            const price = courseCard.textContent.match(/Price: ₹([\d.]+)/)?.[1] || '';
            
            // Scroll to form and fill it
            document.getElementById('section-courses').scrollIntoView({ behavior: 'smooth' });
            const form = document.getElementById('course-form');
            form.title.value = title;
            form.level.value = level.toLowerCase();
            form.price.value = price;
            
            // Store ID for update
            form.dataset.editId = id;
            form.querySelector('.btn-primary').innerHTML = '<i class="fas fa-save"></i> Update Course';
            showNotification('Editing: ' + title, 'info');
        }
        
        // Edit Blog
        function editBlog(id) {
            const blogs = Array.from(document.querySelectorAll('#blogs-list > div'));
            const blogCard = blogs.find(card => card.querySelector(`button[onclick*="${id}"]`));
            if (!blogCard) return;
            
            const title = blogCard.querySelector('h4').textContent;
            const category = blogCard.textContent.match(/Category: ([^\n]+)/)?.[1] || '';
            const author = blogCard.textContent.match(/Author: ([^\n]+)/)?.[1] || '';
            
            // Scroll to form and fill it
            document.getElementById('section-blogs').scrollIntoView({ behavior: 'smooth' });
            const form = document.getElementById('blog-form');
            form.title.value = title;
            form.category.value = category.toLowerCase();
            form.author.value = author;
            
            // Store ID for update
            form.dataset.editId = id;
            form.querySelector('.btn-primary').innerHTML = '<i class="fas fa-save"></i> Update Blog';
            showNotification('Editing: ' + title, 'info');
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Load Users
        async function loadUsers() {
            const loadingEl = document.getElementById('users-loading');
            const tbody = document.getElementById('users-tbody');
            
            try {
                loadingEl.style.display = 'block';
                tbody.innerHTML = '';
                
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const users = data.data.users;
                    
                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: #999;">No users found</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = users.map(user => `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 1rem;">${user.name}</td>
                            <td style="padding: 1rem;">${user.email}</td>
                            <td style="padding: 1rem;">
                                <select onchange="updateUserRole('${user._id}', this.value)" 
                                        style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;"
                                        ${user.email === 'admin@cyberscripts.com' ? 'disabled' : ''}>
                                    <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                    <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>Moderator</option>
                                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </td>
                            <td style="padding: 1rem;">
                                <span style="padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.85rem; 
                                             background: ${user.isActive ? '#e8f5e9' : '#ffebee'}; 
                                             color: ${user.isActive ? '#4caf50' : '#f44336'};">
                                    ${user.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td style="padding: 1rem; font-size: 0.9rem; color: #666;">
                                ${new Date(user.createdAt).toLocaleDateString()}
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <button onclick="toggleUserStatus('${user._id}', ${!user.isActive})" 
                                        class="btn btn-secondary" 
                                        style="padding: 0.5rem 1rem; margin-right: 0.5rem;"
                                        ${user.email === 'admin@cyberscripts.com' ? 'disabled' : ''}>
                                    <i class="fas fa-${user.isActive ? 'ban' : 'check'}"></i>
                                    ${user.isActive ? 'Deactivate' : 'Activate'}
                                </button>
                                <button onclick="deleteUser('${user._id}', '${user.email}')" 
                                        class="btn" 
                                        style="padding: 0.5rem 1rem; background: #f44336; color: white;"
                                        ${user.email === 'admin@cyberscripts.com' ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    showNotification(`Loaded ${users.length} users`, 'success');
                } else {
                    throw new Error(data.message || 'Failed to load users');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Failed to load users: ' + error.message, 'error');
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: #f44336;">Error loading users</td></tr>';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Update user role
        async function updateUserRole(userId, newRole) {
            if (!confirm(`Change user role to ${newRole}?`)) {
                loadUsers(); // Reload to reset dropdown
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ role: newRole })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('User role updated successfully', 'success');
                    loadUsers();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showNotification('Failed to update role: ' + error.message, 'error');
                loadUsers();
            }
        }

        // Toggle user status
        async function toggleUserStatus(userId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ isActive: newStatus })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification(`User ${newStatus ? 'activated' : 'deactivated'} successfully`, 'success');
                    loadUsers();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                showNotification('Failed to update status: ' + error.message, 'error');
            }
        }

        // Delete user
        async function deleteUser(userId, userEmail) {
            if (!confirm(`Are you sure you want to delete user: ${userEmail}?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.status === 204 || response.ok) {
                    showNotification('User deleted successfully', 'success');
                    loadUsers();
                } else {
                    const data = await response.json();
                    throw new Error(data.message);
                }
            } catch (error) {
                showNotification('Failed to delete user: ' + error.message, 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (type === 'error') {
                notification.style.background = '#ff4444';
                notification.style.color = 'white';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // File upload handlers
        document.getElementById('script-file')?.addEventListener('change', function(e) {
            document.getElementById('script-file-name').textContent = e.target.files[0]?.name || '';
        });

        document.getElementById('course-thumbnail')?.addEventListener('change', function(e) {
            document.getElementById('course-thumbnail-name').textContent = e.target.files[0]?.name || '';
        });

        document.getElementById('blog-image')?.addEventListener('change', function(e) {
            document.getElementById('blog-image-name').textContent = e.target.files[0]?.name || '';
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            if (!checkAdminAuth()) return;
            
            // Load dashboard stats
            document.getElementById('total-products').textContent = '15';
            document.getElementById('total-users').textContent = '1';
            document.getElementById('total-orders').textContent = '0';
            document.getElementById('total-revenue').textContent = '$0';
            
            // Load content lists
            loadScripts();
            loadCourses();
            loadBlogs();
        });

        // Prevent back button after logout
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.role || user.role !== 'admin') {
                    window.location.replace('index.html');
                }
            }
        });
    </script>
    
    <!-- Order Management Script -->
    <script src="js/order-management.js"></script>
</body>
</html>
